import { Canvas, Meta, Markdown } from "@storybook/blocks";
import * as EntityDataTableStories from "./mt-entity-data-table.stories";

<Meta of={EntityDataTableStories} />

# Entity Data Table

The `mt-entity-data-table` component is a specialized data table designed to work seamlessly with Shopware's Admin SDK. It simplifies the process of displaying, sorting, paginating, and filtering entity data by abstracting the underlying data fetching and criteria management. This component builds upon the `mt-data-table` by adding entity-specific functionalities.

## Features

- **Automatic Data Fetching**: Connects to Shopware entity repositories to fetch and display data.
- **SDK Integration**: Leverages Shopware's `Criteria` object for powerful data querying.
- **Customizable Columns**: Define columns and their properties.
- **Pagination**: Built-in support for paginating large datasets.
- **Sorting**: Allows users to sort data by specific columns.
- **Search**: Provides a search input to filter data (can be disabled).
- **Filtering**: Supports declarative filter definitions to be applied to the entity criteria.
- **Associations**: Easily include associated entity data.
- **Initial Criteria**: Apply default filters, sorting, or other criteria on component load.
- **Extensible**: Allows providing custom repository instances or Criteria classes for advanced scenarios.
- **Bulk Actions**: Supports bulk editing and deletion if configured.
- **Row Selection**: Allows single or multiple row selection.
- **Forwarded Functionality**: Inherits many display and interaction features from the base `mt-data-table` component, such as layout options, row numbering, stripes, outlines, and more.

---

## Usage

To use `mt-entity-data-table`, you need to provide the entity name and column definitions.

### Minimal Example

This example shows how to display a list of products with basic columns.

```html
<template>
  <mt-entity-data-table
    entity="product"
    :columns="productColumns"
    title="Product Listing"
  />
</template>

<script setup lang="ts">
import { ref } from "vue";
import type { ColumnDefinition } from "./mt-entity-data-table.vue"; // Or from the component itself

const productColumns = ref<ColumnDefinition[]>([
  { property: "name", label: "Name", sortable: true },
  { property: "productNumber", label: "Product Number", sortable: true },
  { property: "active", label: "Active", type: "boolean", sortable: true },
  { property: "stock", label: "Stock", type: "number", sortable: true },
]);
</script>
```

{/* <Canvas of={EntityDataTableStories.MinimalStory} /> */}

### Using `initialCriteria`

You can provide `initialCriteria` to set default sorting, filters, or pagination parameters. For example, to sort by name ascending and only show active products:

```html
<template>
  <mt-entity-data-table
    entity="product"
    :columns="productColumns"
    :initial-criteria="initialProductCriteria"
    title="Active Products (Sorted by Name)"
  />
</template>

<script setup lang="ts">
import { ref } from "vue";
import type { ColumnDefinition } from "./mt-entity-data-table.vue";
// Assuming Criteria types are available globally or imported
// import type { Criteria } from '@shopware-ag/meteor-admin-sdk/data';

const productColumns = ref<ColumnDefinition[]>([
  { property: "name", label: "Name" },
  { property: "productNumber", label: "Product Number" },
]);

const initialProductCriteria = ref({
  // This structure depends on how you build Criteria objects.
  // The component internally uses `sw.data.Classes.Criteria.equals` and `sw.data.Classes.Criteria.sort`
  // For direct property setting on a Criteria instance, the keys would match setters like `setPage`, `setLimit`, etc.
  // For adding filters/sorting, you'd typically pass objects compatible with `addFilter` or `addSorting`.
  // This example assumes `initialCriteria` can directly take Shopware-like filter/sort structures
  // or you might need to pre-construct a Criteria object if the prop expects that.
  // The component's `buildCriteriaInstance` logic will attempt to apply these.

  // To demonstrate applying a filter:
  // This requires knowledge of how `buildCriteriaInstance` processes `initialCriteria`.
  // It iterates `initialCriteria` and calls setters or direct assignment.
  // For filters, you'd likely pass an array if `addFilter` is invoked iteratively,
  // or a pre-built filter object if a `setFilters` method existed (which it doesn't directly).
  // The most straightforward way for `initialCriteria` to add filters might be if it accepted
  // an array of filter objects that the component internally passes to `addFilter`.
  // However, based on the current implementation, `initialCriteria` mainly sets top-level properties.
  // A more robust way is to use the `filters` prop with `initialAppliedFilters` for declarative UI filters.

  // For sorting:
  // The component's `buildCriteriaInstance` directly uses `addSorting` with `defaultSortBy` and `defaultSortDirection`.
  // `initialCriteria` can be used for other criteria aspects, but `defaultSortBy` is preferred for initial sort.
});
</script>
```
For initial sorting, it's often easier to use `defaultSortBy` and `defaultSortDirection` props.
For initial filters that are also user-configurable, use the `filters` and `initialAppliedFilters` props.
`initialCriteria` is powerful for setting up criteria aspects not directly covered by other props, like specific SDK criteria method calls if the internal logic supports them or for properties like `term`.

### Fetching Associations

To include data from associated entities, use the `associations` prop.

```html
<template>
  <mt-entity-data-table
    entity="product"
    :columns="productColumnsWithManufacturer"
    :associations="['manufacturer']"
    title="Products with Manufacturer"
  />
</template>

<script setup lang="ts">
import { ref } from "vue";
import type { ColumnDefinition } from "./mt-entity-data-table.vue";

const productColumnsWithManufacturer = ref<ColumnDefinition[]>([
  { property: "name", label: "Name" },
  { property: "manufacturer.name", label: "Manufacturer" }, // Access nested property
  { property: "stock", label: "Stock", type: "number" },
]);
</script>
```
{/* <Canvas of={EntityDataTableStories.WithAssociationsStory} /> */}

### Using UI Filters

Define available filters using the `filters` prop and set defaults with `initialAppliedFilters`.

```html
<template>
  <mt-entity-data-table
    entity="order"
    :columns="orderColumns"
    :filters="orderFilters"
    :initial-applied-filters="initialOrderFilters"
    title="Orders"
  />
</template>

<script setup lang="ts">
import { ref } from "vue";
import type { ColumnDefinition, Filter } from "./mt-entity-data-table.vue";

const orderColumns = ref<ColumnDefinition[]>([
  { property: "orderNumber", label: "Order Number" },
  { property: "orderCustomer.firstName", label: "Customer First Name" },
  { property: "amountTotal", label: "Total", type: "price" }, // Assuming a price type exists
  { property: "stateMachineState.name", label: "Status" },
]);

const orderFilters = ref<Filter[]>([
  {
    id: "stateMachineState.technicalName",
    label: "Status",
    type: {
      name: "select", // This structure depends on mt-data-table's filter type definitions
      options: [
        { id: "open", label: "Open" },
        { id: "in_progress", label: "In Progress" },
        { id: "completed", label: "Completed" },
        { id: "cancelled", label: "Cancelled" },
      ],
    },
  },
  // Add more filters as needed
]);

const initialOrderFilters = ref<Filter[]>([
  {
    id: "stateMachineState.technicalName",
    label: "Status", // Label might not be strictly needed here if matching by ID
    type: {
      name: "select",
      options: [{ id: "open", label: "Open" }], // Pre-select "Open"
    },
  },
]);
</script>
```
{/* <Canvas of={EntityDataTableStories.WithFiltersStory} /> */}

---

## Props

The `mt-entity-data-table` accepts the following props:

<Markdown>
  {`
| Prop Name                      | Type                                                  | Required | Default                                  | Description                                                                                                |
| ------------------------------ | ----------------------------------------------------- | -------- | ---------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| \`entity\`                     | \`String\`                                              | Yes      |                                          | The name of the Shopware entity to display (e.g., "product", "order").                                     |
| \`columns\`                    | \`ColumnDefinition[]\`                                | Yes      |                                          | An array of column definitions for the table.                                                              |
| \`columnChanges\`              | \`Record<string, ColumnChanges>\`                       | No       | \`{}\`                                     | Object to track changes in column visibility or order.                                                       |
| \`title\`                      | \`String\`                                              | No       | \`""\`                                   | Title for the data table.                                                                                  |
| \`subtitle\`                   | \`String\`                                              | No       | \`""\`                                   | Subtitle for the data table.                                                                               |
| \`layout\`                     | \`"default" \\| "full"\`                               | No       | \`"default"\`                             | Layout of the data table.                                                                                  |
| \`enableReload\`               | \`Boolean\`                                             | No       | \`true\`                                 | Whether to show a reload button.                                                                           |
| \`defaultSortBy\`              | \`String\`                                              | No       | \`undefined\`                             | Default column property to sort by.                                                                        |
| \`defaultSortDirection\`       | \`"ASC" \\| "DESC"\`                                  | No       | \`"ASC"\`                                | Default sort direction.                                                                                    |
| \`initialCriteria\`            | \`Partial<Criteria>\`                                   | No       | \`{}\`                                     | An object representing initial criteria settings for the Shopware SDK Criteria object.                     |
| \`associations\`               | \`string[]\`                                            | No       | \`[]\`                                   | An array of association paths to load with the entity (e.g., \`['manufacturer', 'cover.media']\`).         |
| \`providedRepository\`         | \`Repository<keyof EntitySchema.Entities> \\| null\`    | No       | \`null\`                                 | Optionally provide an external Shopware Admin SDK Repository instance.                                       |
| \`providedCriteriaClass\`      | \`Function\` (constructor)                              | No       | \`null\`                                 | Optionally provide an external Criteria class constructor compatible with Shopware Admin SDK.                |
| \`providedCriteriaStaticHelpers\` | \`CriteriaStaticHelpers \\| null\`                    | No       | \`null\`                                 | Optionally provide external Criteria static helper methods (equals, sort, multi).                        |
| \`paginationOptions\`          | \`number[]\`                                            | No       | \`[5, 10, 25, 50]\`                       | Options for items per page in pagination. Passed to \`mt-data-table\`.                                       |
| \`disableSearch\`              | \`Boolean\`                                             | No       | \`false\`                                | Disables the search input. Passed to \`mt-data-table\`.                                                    |
| \`allowRowSelection\`          | \`Boolean\`                                             | No       | \`false\`                                | Enables row selection. Passed to \`mt-data-table\`.                                                        |
| \`selectedRows\`               | \`string[]\` (IDs)                                      | No       | \`[]\`                                   | Array of selected row IDs. Passed to \`mt-data-table\`.                                                    |
| \`allowBulkEdit\`              | \`Boolean\`                                             | No       | \`false\`                                | Enables bulk edit functionality. Passed to \`mt-data-table\`.                                              |
| \`allowBulkDelete\`            | \`Boolean\`                                             | No       | \`false\`                                | Enables bulk delete functionality. Passed to \`mt-data-table\`.                                            |
| \`bulkEditMoreActions\`        | \`any[]\`                                               | No       | \`[]\`                                   | Additional actions for bulk editing. Passed to \`mt-data-table\`.                                          |
| \`enableRowNumbering\`         | \`Boolean\`                                             | No       | \`false\`                                | Shows row numbers. Passed to \`mt-data-table\`.                                                            |
| \`showStripes\`                | \`Boolean\`                                             | No       | \`true\`                                 | Shows stripes on rows. Passed to \`mt-data-table\`.                                                        |
| \`showOutlines\`               | \`Boolean\`                                             | No       | \`true\`                                 | Shows outlines for the table. Passed to \`mt-data-table\`.                                                 |
| \`enableOutlineFraming\`       | \`Boolean\`                                             | No       | \`false\`                                | Enables outline framing. Passed to \`mt-data-table\`.                                                      |
| \`disableDelete\`              | \`Boolean\`                                             | No       | \`false\`                                | Disables delete actions per row. Passed to \`mt-data-table\`.                                              |
| \`disableEdit\`                | \`Boolean\`                                             | No       | \`false\`                                | Disables edit actions per row. Passed to \`mt-data-table\`.                                                |
| \`disableSettingsTable\`       | \`Boolean\`                                             | No       | \`false\`                                | Disables the table settings options (like column visibility). Passed to \`mt-data-table\`.                 |
| \`caption\`                    | \`String\`                                              | No       | \`"Data table"\`                          | Caption for accessibility. Passed to \`mt-data-table\`.                                                    |
| \`filters\`                    | \`Filter[]\`                                            | No       | \`[]\`                                   | Defines available UI filters for the table. Passed to \`mt-data-table\`.                                   |
| \`initialAppliedFilters\`      | \`Filter[]\`                                            | No       | \`[]\`                                   | Sets initially applied filters from the \`filters\` list.                                                  |
`}
</Markdown>

The types `ColumnDefinition`, `ColumnChanges`, and `Filter` are re-exported from `mt-entity-data-table.vue` for convenience. You can import them directly from this component file.

---

## Events

The component emits the following events:

<Markdown>
  {`
| Event Name                    | Payload Description                                                                   | Description                                                                                    |
| ----------------------------- | ------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------- |
| \`open-details\`              | \`item: object\` (The entity item data)                                               | Emitted when a row's detail action is triggered (if applicable).                               |
| \`selection-change\`          | \`selection: string[]\` (Array of selected item IDs)                                  | Emitted when the row selection changes (for single selection mode).                            |
| \`multiple-selection-change\` | \`selection: string[]\` (Array of selected item IDs)                                  | Emitted when the row selection changes (for multiple selection mode).                          |
| \`bulk-edit\`                 | \`void\`                                                                              | Emitted when the bulk edit action is triggered.                                                |
| \`bulk-delete\`               | \`void\`                                                                              | Emitted when the bulk delete action is triggered.                                              |
| \`change-show-outlines\`      | \`value: boolean\`                                                                    | Emitted when the 'show outlines' setting changes.                                              |
| \`change-show-stripes\`       | \`value: boolean\`                                                                    | Emitted when the 'show stripes' setting changes.                                               |
| \`change-outline-framing\`    | \`value: boolean\`                                                                    | Emitted when the 'outline framing' setting changes.                                            |
| \`change-enable-row-numbering\` | \`value: boolean\`                                                                    | Emitted when the 'enable row numbering' setting changes.                                       |
| \`item-delete\`               | \`item: object\` (The entity item data)                                               | Emitted when an individual item delete action is triggered.                                    |
| \`data-loaded\`               | \`{ items: any[], total: number }\`                                                   | Emitted after data has been successfully fetched and processed. \`items\` is the current page data, \`total\` is the overall total count of items. |
| \`load-error\`                | \`error: Error\`                                                                      | Emitted if an error occurs during data fetching.                                               |
`}
</Markdown>

Additionally, it forwards several events from the underlying `mt-data-table` related to pagination, sorting, search, and filter changes. These are handled internally to refetch data but can also be listened to if needed:
- `pagination-limit-change`
- `pagination-current-page-change`
- `search-value-change`
- `sort-change`
- `update:appliedFilters`

---

## Slots

The `mt-entity-data-table` forwards all slots to the underlying `mt-data-table` component. This means you can use any slots provided by `mt-data-table` to customize the rendering of columns, cells, headers, or other parts of the table.

Common slots you might use include:
- `cell-<property>`: To customize rendering for a specific column's cells (e.g., `cell-name`).
- `header-<property>`: To customize rendering for a specific column's header.
- `actions`: To customize the actions column for each row.
- `bulk-actions`: To customize the bulk actions area.

Please refer to the `mt-data-table` documentation for a complete list of available slots and their usage.

Example of using a cell slot:
```html
<template>
  <mt-entity-data-table
    entity="product"
    :columns="productColumns"
  >
    <template #cell-active="{ item }">
      <span :style="{ color: item.active ? 'green' : 'red' }">
        {{ item.active ? 'Yes' : 'No' }}
      </span>
    </template>
  </mt-entity-data-table>
</template>

<script setup lang="ts">
// ... columns definition
</script>
```

---

## Data Fetching and SDK Integration

The `mt-entity-data-table` handles data fetching automatically using the Shopware Admin SDK.
1.  It obtains a repository instance for the specified `entity` using `sw.data.repository(props.entity)`.
2.  It constructs a `Criteria` object (`sw.data.Classes.Criteria`) based on the current state:
    *   Pagination (current page, limit).
    *   Sorting (sort by, sort direction).
    *   Search term.
    *   Applied filters (from the `currentAppliedFilters` ref, which is updated by the `filters` prop).
    *   Associations (from the `associations` prop).
    *   `initialCriteria` properties are merged into this Criteria object.
3.  It calls the `search()` method on the repository with the constructed criteria.
4.  The results are then used to populate the `dataSource`, and `paginationTotalItems` is updated.

### Advanced Customization

-   **`providedRepository`**: If you have a custom or pre-configured repository instance, you can pass it via this prop. The component will use this instance instead of creating one.
-   **`providedCriteriaClass`**: If you need to use a custom Criteria class (e.g., an extended version), you can provide its constructor function here.
-   **`providedCriteriaStaticHelpers`**: If your custom Criteria implementation relies on different static helper methods (like `Criteria.equals`, `Criteria.multi`), you can provide an object mapping to these custom functions. This is useful if the static methods are not directly on the `providedCriteriaClass` or have different signatures/locations.

These advanced props allow for significant flexibility if the default SDK integration needs to be adapted for specific use cases or different data sources that still conform to the repository/criteria pattern. 